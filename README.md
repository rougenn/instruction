# Инструкция по подключению и взаимодействию с Raspberry Pi 5
## ORBSLAM3 launch
1.	**Подключение к распберри пай**
    а) Назвать свою точку доступа “kkklll”, пароль – “123456780”; после включения распберри пай подключится и можно будет с ним взаимодейстовать
    б) Подключится по ethernet кабелю
        После подключения можно подключить другой вайфай
    ```bash
    sudo raspi-config
    ```
    Перейти в параметры устройства и вайфай подключения, далее установить желаемое подключение.
    в) Подключить мышку, клавиатуру и монитор напрямую к устройству, взаимодействовать там
2.  **Сразу после первого перезагрузить устройство командой**
    ```bash
    sudo reboot
    ```
    для того, чтобы инерциальный модуль смог откалиброваться (нужно подождать 30 секунд)
3. **Запустить докер контейнер**
    ```bash
    ./run_container.sh
    ```
4. **В докере зайти в папку /home и запустить ноды**
    ```bash
    cd /home
    ./run_nodes.sh --all
    ```
    Можно запускать разные ноды используя разные флаги, чтобы посмотреть все флаги, нужно написать
    ```bash
    ./run_nodes.sh

    # output:
    # --camera  start camera node
    # --imu     start IMU node
    # --fox     start Foxglove + trajectory tf - для 
    #                                            отображения траектории в фоксглов
    # --slam    start SLAM node
    # --udp     start UDP publisher
    # --all     start all nodes
    ```
5. **Чтобы подключить фоксглов, надо скачать его по ссылке https://foxglove.dev/download**
    После нужно в хосте распберри пай написать
    ```bash
    ifconfig # смотрите поле айпи именно того интерфейса,
             # по которому подключено устройство
    ```
    чтобы узнать, какое айпи имеет устройство
    Далее нужно зайти в фоксглов, нажать "open connections", изменить localhost на найденный айпи устройства:
    ![alt text](image.png)
6. **Далее нужно настроить фоксглов, выставить нужные виджеты для мониторинга.** 
    См следующий пункт

## Настройка foxglove
1. Для отображения траектории в 2д, нужно выставить такие настройки в виджете *Plot*
![alt text](image-1.png)
2. Для отображения моментной позы, нужно выбрать в виджете *3D* топик transform или tf
3. Чтобы отобразить текущую картинку, следует в виджете *Image* выбрать топик /camera/image_raw/compressed
4. Для отображения выходных данных орбслема или данных иму, надо выбрать виджет *Raw messages* и подписаться на /odometry/slam и /imu/data_raw соответственно

## Перезапуск ORBSLAM
1. Чтобы выполнить перезапуск орбслема, надо остановить текущий процесс орбслема, подав сигнал ctrl+c
2. Заново запустить слем той же командой, подождать 10 секунд до запуска

## Сохранение траектории слема
Из-за того, что скрипт run_nodes.sh убивает процессы, слем не может сохранить траекторию в /home/FrameTrajectory.txt. Чтобы это обойти, надо:
1. Запустить слем командой 
```bash
source /opt/ros/humble/setup.bash
source /home/examples_ws/install/setup.bash
export LD_LIBRARY_PATH=/home/ORB_SLAM3/lib:/usr/local/lib:$LD_LIBRARY_PATH
# ------------- один раз при создании терминала --------------


# запустить слем командой
ros2 launch slam_example slam_example.launch.py
```
2. После этого запустить нужные топики, кроме слема (в отдельном терминале)
```bash
cd /home 
./run_nodes.sh --camera --imu --fox # это пример, можно запустить в своей конфигурации,
                                    # главное не запускать с флагом --slam, тк  
                                    # он уже запущен
```
3. Траектория сохранится по пути `/home/FrameTrajectory.txt`


## Настройка камеры
1. Зайти в файл run_nodes.sh в любом редакторе, допустим:
```bash
cd /home
nano run_nodes.sh
```
Все последующие настройки проводить в блоке кода, начинающемся со строки `launch_camera() {` (19 - 53 строки), который отвечает за камеру
2. Самое частое изменение - отредактировать gain до нужной величины, чтобы компенсировать яркость/темноту кадра
```bash
-p AnalogueGain:=1.0 \ # <----- обычно хватает значения в диапазоне 1.0-6.0
```
3. Запустить камеру и фоксглов, чтобы проверить, насколько изменилась яркость кадра
```bash
cd /home
./run_nodes.sh --camera --fox
```
4. Другие параметры (не рекомендуется менять)
```bash
ros2 run camera_ros camera_node \
  --ros-args \
  -p width:=$CAMERA_WIDTH \
  -p height:=$CAMERA_HEIGHT \
  -p camera:=1 \
  -p format:=BGR888 \
  -p orientation:=180 \
  -p role:=still \
  -p sensor_mode:="640:480" \
  \
  # экспозиция вручную (режим 1 = ручной)
  -p ExposureTimeMode:=1 \
  -p ExposureTime:=2000           # 2 ms выдержки \
  \
  # усилитель (gain) вручную
  -p AnalogueGainMode:=1 \
  -p AnalogueGain:=1.0            # гейн, минимальное значение - 1.0 \
  \
  # авто-фликер/мигание и баланс белого
  -p AeFlickerMode:=0             # подавление мерцания ламп (0 = выкл.) \
  -p AwbEnable:=true              # авто-баланс белого \
  -p AwbMode:=0                   # 0 = Auto; можно сменить на 2/3/5 при не-Auto \
  \
  # базовые шум-и-динамика
  -p StatsOutputEnable:=false     # отключаем статистику на чёрный кадр \
  -p HdrMode:=0                   # без HDR, чтобы избежать артефактов \
  -p FrameDurationLimits:="[66666,66666]"  # строго 15 fps, при изменении нужно менять \
                                  # в файле /home/examples_ws/src/slam_example/config/camera_and_slam_settings.yaml \
                                  # задается в формате 1e6/fps
  # удобство качества картинки (лучше не добавлять эти параметры)
  -p Brightness:=0.0              # смещение яркости (–1..+1) \
  -p Contrast:=2.0                # контраст (0..32): 2.0 \
  -p Saturation:=1.0              # насыщенность (0..32): 1.0 = дефолтное цветопередача \
  -p Sharpness:=0.0               # резкость (0..16): 0 = без искусственного шумоподъёма \
  \
  # QoS для публикации
  -p qos_overrides./rover_camera/image_raw.publisher.reliability:=best_effort \
  -p qos_overrides./rover_camera/image_raw.publisher.history:=keep_last \
  -p qos_overrides./rover_camera/image_raw.publisher.depth:=1 \
  \
  -r /camera/image_raw:=/rover_camera/image_raw

```

## Настройки и проверка UDP соединения
1. Юдп соединение запускается флагом --udp при запуске нод, так же включено во флаг --all
```bash
./run_nodes.sh --udp
```
2. Бывает такое, что порт не открывается, надо сделать это еще раз вручную.
    Нужно в другом терминале подключится к распберри пай и в хосте выполнить
```bash
ip addr flush dev eth0
ip addr add 10.0.0.1/24 dev eth0
ip link set eth0 up
```

## Дополнительно
Для передачи бинарных данных работы иму, надо вытащить сбоку из корпуса sd карту, вставить в любое устройство и скачать оттуда .bin файлы.


## Contacts
При возникновении вопросов - *[t.me/rougenn](https://t.me/rougenn)* 
